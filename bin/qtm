#!/usr/bin/env bash
set -euo pipefail
# ----------------------------
# Global flags (non-breaking extension)
# ----------------------------
JSON_ONLY=0

# Allow --json either before the command or after it (probe --json)
# We parse a leading --json first; later we also check per-command args.
if [[ "${1:-}" == "--json" ]]; then
  JSON_ONLY=1
  shift
fi

# ----------------------------
# QTM Macro (FROZEN): prints on every invocation
# ----------------------------
# ----------------------------
# QTM Macro (FROZEN): prints on every invocation
# ----------------------------
if [[ "$JSON_ONLY" -eq 0 ]]; then
  cat <<'BANNER'
QQQQQQQQQQQQQ    TTTTTTTTTTTTTTTTTT     MMMM           MMMM
QQ         QQ            TTT            MMMMMM        MMMMM
QQ         QQ            TTT            MM  MMMM    MMMM MM
QQ         QQ            TTT            MM    MMMM MMMM  MM
QQ         QQ            TTT            MM      MMMM     MM
QQ   QQQ   QQ            TTT            MM               MM
QQ     Q   QQ            TTT            MM               MM
QQ      QQQQ             TTT            MM               MM
 QQQQQQQQQ QQ            TTT            MM               MM
            QQQ
BANNER
fi

# ----------------------------
# Deterministic outputs (no env/time/network)
# ----------------------------

print_help() {
  cat <<'HELP_EOF'
QTM CLI v0.01 (QTM OS)

Usage:
  qtm [--help|--version|--spec] <command> [args]

Global Flags:
  --help        Print help and exit
  --version     Print runtime version header and exit
  --spec        Print CLI spec references and exit
  --json        Emit JSON only (suppresses macro/banner)


Commands (reserved namespaces):
  help          Print help and exit
  version       Print runtime version header and exit
  inspect       Read-only inspection (no validation, no mutation)
  runtime       Reserved namespace (no mutation at v0.01)
  surface       Reserved namespace (no surface load/start at v0.01)
  probe         Dry-run OS baseline test (no network, no execution)

Notes:
  - No authority is inferred.
  - No background services are started.
  - No Planck/OMNI/surface dependency.
HELP_EOF
}

print_spec_refs() {
  cat <<'SPEC_EOF'
CLI Specs (repo paths):
  - docs/cli/QTM_CLI_SKELETON_v0.01.md
  - docs/cli/QTM_RUNTIME_VERSION_HEADER_v0.01.md
  - docs/cli/QTM_OS_DEPLOYMENT_DRILL_CHECKLIST_v0.01.md
  - docs/cli/QTM_SURFACE_KILL_TEST_v0.01.md
  - docs/cli/CLI_TO_RUNTIME_MAPPING_v0.01.md
  - docs/cli/QTM_CLI_FREEZE_MANIFEST_v0.01.md
SPEC_EOF
}

print_runtime_header() {
  cat <<'RUNTIME_EOF'
QTM Runtime v0.01
Layer: QTM OS
Frozen Components:
  - QTM_MACRO_v0.01
  - QTM_CLI_SKELETON_v0.01
  - QTM_OS_DEPLOYMENT_DRILL_CHECKLIST_v0.01
  - QTM_SURFACE_KILL_TEST_v0.01
  - CLI_TO_RUNTIME_MAPPING_v0.01
  - QTM_CLI_FREEZE_MANIFEST_v0.01
  - QTM_RUNTIME_VERSION_HEADER_v0.01
Build Reference: git:@QTM_BUILD_REF@
Declaration: Non-authoritative, declarative runtime header
RUNTIME_EOF
}

# ----------------------------
# Minimal dispatcher (v0.01): no-op routing only
# ----------------------------
cmd="${1:-}"

case "$cmd" in
  ""|--help|help)
    print_help
    exit 0
    ;;

  --spec)
    print_spec_refs
    exit 0
    ;;

  --version|version)
    print_runtime_header
    exit 0
    ;;

  inspect)
    # Read-only. No validation. No mutation.
    cat <<'INSPECT_EOF'
qtm inspect (v0.01)
- Mode: read-only
- Notes: no validation, no mutation, no surfaces, no Planck, no OMNI
INSPECT_EOF
    exit 0
    ;;

  runtime)
    # Reserved namespace: no mutation at v0.01
    cat <<'RUNTIME_CMD_EOF'
qtm runtime (v0.01)
- Reserved namespace
- No mutation permitted at v0.01
RUNTIME_CMD_EOF
    exit 0
    ;;

  surface)
    # Reserved namespace: MUST NOT load/start surfaces at v0.01
    cat <<'SURFACE_EOF'
qtm surface (v0.01)
- Reserved namespace
- No surface load/start at v0.01
SURFACE_EOF
    exit 0
    ;;

  probe)
    if [[ "${2:-}" == "--json" ]]; then JSON_ONLY=1; fi
    # QTM PROBE (v0.01a): dry-run baseline
    # MUST: deterministic output, no env/time/network, no execution

    OMNI_PRESENT=false
    if [[ -d "omni" && -f "omni/OMNI_INTERFACE_SPEC_v0.01.md" ]]; then
      OMNI_PRESENT=true
    fi
    OMNI_STATUS="missing"
    if [[ "$OMNI_PRESENT" == "true" ]]; then
      OMNI_STATUS="available"
    fi

    PLANCK_PRESENT=false
    if [[ -d "planck" && -f "planck/PLANCK_SURFACE_MANAGER_SPEC_v0.01.md" ]]; then
      PLANCK_PRESENT=true
    fi
    PLANCK_STATUS="missing"
    if [[ "$PLANCK_PRESENT" == "true" ]]; then
      PLANCK_STATUS="available"
    fi

    cat <<PROBE_JSON
{
  "spec_version": "v0.01",
  "command": "probe",
  "ok": true,
  "result": {
    "probe": {
      "summary": {
        "omni_present": ${OMNI_PRESENT},
        "omni_status": "${OMNI_STATUS}",
        "planck_present": ${PLANCK_PRESENT},
        "planck_status": "${PLANCK_STATUS}",
        "surface_exec": "blocked"
      },
      "invariants": [
        "no_network",
        "no_execution",
        "deterministic_output"
      ],
      "notes": [
        "dry_run_only"
      ]
    }
  }
}
PROBE_JSON
    exit 0
    ;;

  *)
    # Deterministic usage error
    echo "qtm: unknown command: $cmd" >&2
    echo "qtm: run 'qtm --help' for usage" >&2
    exit 2
    ;;
esac
EOF
chmod +x bin/qtm
